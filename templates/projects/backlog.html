{% extends 'base_generic.html' %}
{% load static %}
{% load widget_tweaks %}
{% block title %}Main{% endblock %}

{% block content %}
    {% csrf_token %}

    <style>
    * {
        box-sizing: content-box;
    }

    .sidebar-link {
        background-color: #343A40;
        border-color: #343A40;
        color: #CCDDE2;
        margin-bottom: 1vh;
    }

    i {
            margin-right: 30px;
    }

    .avatar {
        border: #343A40 7px solid;
    }

    .avatar-p {
        background-color: #343A40;
    }

    ul.list-unstyled::-webkit-scrollbar {
        width: 8px;
    }

    ul.list-unstyled::-webkit-scrollbar-thumb {
        background-color: #DD6E42;
        border-radius: 4px;
    }

    ul.list-unstyled::-webkit-scrollbar-thumb:hover {
        background-color: #CC5A35;
    }

    ul.list-unstyled::-webkit-scrollbar-track {
        background-color: #343A40;
    }

    .form-select {
        width: 15%;
    }

    .filter-button {
        color: #DD6E42;
        background-color: #212529;
        border-color: #DD6E42;
    }

    .filter-button:hover {
        background-color: #DD6E42;
        color: #CCDDE2;
        border-color: #DD6E42;
    }

    .task-item {
        background-color: #343A40;
        color: #CCDDE2;
    }

    .hidden {
        visibility: hidden;
        opacity: 0;
    }

    .visible {
        visibility: visible;
        opacity: 1;
        transition: opacity 0.3s ease;
    }

    li.task-item.active {
        background-color: #CCDDE2;
        border: 2px solid #CCDDE2;
        color: #212529;
        font-weight: bold;
    }

    .card-label {
        position: absolute;
        top: -10px;
        left: 10px;
        background: #212529;
        padding: 0 10px;
        font-size: 14px;
        color: #CCDDE2;
        font-weight: bold;
    }

    .card-task-detail {
        color: #CCDDE2;
        background-color: #212529;
        border: 1px solid #CCDDE2;

    }

    </style>

    <section class="text-center text-lg-start" style="max-height: 83vh;">
        <div class="container d-flex align-items-center px-0"  style="height: 83vh; padding-top: 3vh">
            <div class="row w-100 h-100 d-flex flex-column justify-content-start align-items-center" style="flex: 1; ">

                <div class="col-auto bg-dark d-flex flex-column py-3" style="max-height: 27vh; min-width: 10vw; border-radius: 10px">
                    <img class="avatar" src="{% static 'Login.jpg' %}" alt="" style="width: 100px; height: 100px; object-fit: cover; border-radius: 50%; margin: 0 auto;">

                    <div class="text-center mt-2 avatar-p rounded py-1">
                        <p class="m-0">{{ request.user.username }}</p>
                        <small class="m-0">Activity: 13.6h</small>
                    </div>
                </div>

                <div class="col-auto bg-dark d-flex flex-column py-3 mt-3" style="max-height: 86vh; min-width: 10vw; border-radius: 10px">
                    <a href="{% url 'projects:main' project.id %}" class="sidebar-link btn btn-secondary text-start"><i class="bi bi-house-fill"></i>Main</a>
                    <a href="#" class="sidebar-link btn btn-secondary text-start"><i class="bi bi-list-columns-reverse"></i>Backlog</a>
                    <a href="#" class="sidebar-link btn btn-secondary text-start"><i class="bi bi-kanban-fill"></i>Board</a>
                    <a href="#" class="sidebar-link btn btn-secondary text-start"><i class="bi bi-chat-dots-fill"></i>Chat</a>
                    <a href="#" class="sidebar-link btn btn-secondary text-start"><i class="bi bi-pie-chart-fill"></i>Charts</a>
                    <a href="#" class="sidebar-link btn btn-secondary text-start mb-0"><i class="bi bi-gear-fill"></i> Settings</a>
                </div>

                <div class="col-5 bg-dark rounded p-3" style="height: 76vh;">
                    <form method="get" class="backlog-form d-flex justify-content-start mb-3">
                        <select class="form-select form-select-sm me-3" name="status" id="select-status">
                            <option value="" {% if not current_status %}selected{% endif %}>All statuses</option>
                            <option value="in progress" {% if current_status == "in progress" %}selected{% endif %}>In progress</option>
                            <option value="to do" {% if current_status == "to do" %}selected{% endif %}>To do</option>
                            <option value="on hold" {% if current_status == "on hold" %}selected{% endif %}>On hold</option>
                            <option value="done" {% if current_status == "done" %}selected{% endif %}>Done</option>
                        </select>

                        <select class="form-select form-select-sm me-3" name="priority" id="select-priority">
                            <option value="" {% if not current_priority %}selected{% endif %}>All priorities</option>
                            <option value="trivial" {% if current_priority == "trivial" %}selected{% endif %}>Trivial</option>
                            <option value="low" {% if current_priority == "low" %}selected{% endif %}>Low</option>
                            <option value="medium" {% if current_priority == "medium" %}selected{% endif %}>Medium</option>
                            <option value="high" {% if current_priority == "high" %}selected{% endif %}>High</option>
                        </select>

                        <select class="form-select form-select-sm" name="user" id="select-user">
                            <option value="" {% if not current_user %}selected{% endif %}>All members</option>
                            {% for member in members %}
                                <option value="{{ member.user }}" {% if current_user == member.user.username %}selected{% endif %}>
                                    {{ member.user }}
                                </option>
                            {% endfor %}
                        </select>

                        <button type="submit" class="btn filter-button btn-sm ms-auto">
                            <i class="bi bi-funnel-fill m-0 me-2"></i>Filter
                        </button>
                    </form>

                    <hr>

                    <ul class="list-group list-unstyled" style="max-height: 63vh; overflow-y: auto;">
                    {% for task in tasks %}
                        <li class="task-item list-group-item d-flex align-items-center justify-content-between mb-2 mx-2 rounded"
                            id="task-{{ task.id }}"
                            style="cursor: pointer;"
                            data-task-id="{{ task.id }}" onclick="selectTask(this)"
                        >

                            <div class="d-flex align-items-center">
                                <div>
                                    <strong>{{ task.title }}</strong>
                                    <div class="text-muted small">Assigned to: {{ task.user }}</div>
                                </div>
                            </div>

                            <div class="text-end">
                                <div class="task-status text-uppercase">{{ task.status }}</div>
                                <div class="task-priority text-muted small text-uppercase">Priority: {{ task.priority }}</div>
                            </div>
                        </li>
                    {% endfor %}
                    </ul>
                </div>

                <div id="task-detail" class="col-4 bg-dark rounded hidden p-3" style="height: 76vh;">
                        <!-- Task details will be dynamically inserted here -->
                </div>
            </div>
        </div>

        <div class="modal fade" id="deleteTaskModal" tabindex="-1" aria-labelledby="deleteTaskLabel" aria-hidden="true">
            <div class="modal-dialog" style="color: #CCDDE2">
                <div class="modal-content bg-dark" style="width: 80%;">
                    <div class="modal-body text-center">
                    Are you sure you want to delete this task?
                    </div>

                    <div class="pb-3 px-3">
                        <button type="button" class="btn btn-secondary float-start" data-bs-dismiss="modal"><i class="bi bi-backspace-fill me-2"></i>Back</button>
                        <button type="button" id="confirmDeleteBtn" class="btn btn-danger float-end"><i class="bi bi-check-circle-fill me-2"></i>Go ahead!</button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <script>
    let activeTask = null;

    function selectTask(element) {
        const taskId = element.dataset.taskId;

        document.querySelectorAll('.task-item').forEach(task => task.classList.remove('active'));
        element.classList.add('active');

        fetch(`/projects/task-detail/${taskId}/`)
            .then(response => response.json())
            .then(data => {
                const taskDetail = document.getElementById('task-detail');
                taskDetail.innerHTML = `
                    <div class="d-flex flex-column" style="height: 100%;">
                        <div class="task-detail-header">
                            <div class="task-detail-header d-flex align-items-center mb-2">
                                <h4 class="w-100 m-0">${data.title}</h4>
                            </div>
                            <p>${data.description}</p>

                            <div class="d-flex justify-content-around mb-3">
                                <div class="card-task-detail card position-relative rounded">
                                    <span class="card-label">Dates</span>
                                    <div class="card-body small">
                                        <p class="m-0">Created: ${data.created_at}</p>
                                        <p class="m-0">Updated: ${data.updated_at}</p>
                                    </div>
                                </div>

                                <div class="card-task-detail card position-relative rounded">
                                    <span class="card-label">Time Tracking</span>
                                    <div class="card-body small">
                                        <p class="m-0">Estimated: ${data.original_estimate}</p>
                                        <p class="m-0">Remaining: ${data.remaining_estimate}</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="task-detail-log mb-3 rounded flex-grow-1 " style="background-color: #343A40">
                            <h4>Here will be task log.</h4>
                            <h5>Information about previous steps and general history of tasks.</h5>
                            <h4>${data.id}</h4>
                        </div>

                         <div class="task-manager mt-auto">
                            <button type="button" class="btn btn-success float-start">
                                <i class="bi bi-pen-fill me-2"></i>Edit
                            </button>
                            <button type="button" id="deleteTaskBtn" class="btn btn-danger float-end" data-task-id="${data.id}">
                                <i class="bi bi-trash-fill me-2"></i>Delete
                            </button>
                        </div>
                    </div>
                `;

                const detailBlock = document.getElementById('task-detail');
                detailBlock.classList.remove('hidden');
                detailBlock.classList.add('visible');

                const taskDetailLog = document.querySelector('.task-detail-log');
                getComputedStyle(taskDetailLog).height;
            })
            .catch(error => {
                console.error('Error fetching task details:', error);
            });

        activeTask = taskId;
    }

    function deleteTask(taskId) {
        fetch(`/projects/task-delete/${taskId}/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            },
        })
        .then(response => {
            if (!response.ok) throw new Error('Ошибка удаления задачи');
            return response.json();
        })
        .then(data => {
            if (data.message) {
                location.reload();
            }
        })
        .catch(error => console.error('Ошибка:', error));
    }

    function showDeleteModal(taskId) {
        // Открываем модальное окно
        const modal = new bootstrap.Modal(document.getElementById('deleteTaskModal'));
        modal.show();

        // Навешиваем обработчик на кнопку подтверждения
        const confirmButton = document.getElementById('confirmDeleteBtn');
        confirmButton.onclick = function () {
            deleteTask(taskId);
            modal.hide();
        };
    }

    // Обработчик для клика по кнопкам "Удалить"
    document.addEventListener('click', function (event) {
        const deleteButton = event.target.closest('#deleteTaskBtn');
        if (deleteButton) {
            const taskId = deleteButton.dataset.taskId; // Получаем ID задачи из data-атрибута
            showDeleteModal(taskId);  // Открываем модальное окно с соответствующим taskId
        }
    })

    // (Необязательно) Обновление списка задач, если необходимо
    function updateTaskList() {
        fetch('/projects/tasks/')
            .then(response => response.text())
            .then(html => {
                const taskListContainer = document.querySelector('.task-list'); // Ваш селектор для списка задач
                if (taskListContainer) {
                    taskListContainer.innerHTML = html;
                }
            })
            .catch(error => console.error('Ошибка при обновлении списка задач:', error));
    }
    </script>
{% endblock %}